---
title: "Music Taste"
author: "Sebastiaan Aflaki"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: journal
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE)

library(tidyverse)
library(spotifyr)
library(ggfortify)
library(flexdashboard)
library(readr)
library(lubridate)
library(ggplot2)
library(plotly)
library(compmus)
library(ggthemes)
library(patchwork)
library(ggdendro)
library(heatmaply)
library(tidymodels)
sebas <- get_playlist_audio_features("", "5zSzru2LrIR0o8SUyLelyd")

sebas <- sebas %>%
  filter(!is.na(key))

wrapped16 <- get_playlist_audio_features("", "37i9dQZF1Cz24RS3exilwM") %>% filter(!is.na(key))
wrapped17 <- get_playlist_audio_features("", "37i9dQZF1E9Jzat5fcogxI") %>% filter(!is.na(key))
wrapped18 <- get_playlist_audio_features("", "37i9dQZF1EjvCrCRRFYOR7") %>% filter(!is.na(key))
wrapped19 <- get_playlist_audio_features("", "37i9dQZF1Etlshd0CHSHbz") %>% filter(!is.na(key))
wrapped20 <- get_playlist_audio_features("", "37i9dQZF1EMdGOBLndfzlm") %>% filter(!is.na(key))

get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit %>% 
    collect_predictions() %>% 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit %>% 
    conf_mat_resampled() %>% 
    group_by(Prediction) %>% mutate(precision = Freq / sum(Freq)) %>% 
    group_by(Truth) %>% mutate(recall = Freq / sum(Freq)) %>% 
    ungroup() %>% filter(Prediction == Truth) %>% 
    select(class = Prediction, precision, recall)
}  

```

```{r prepro wrapped, include=FALSE, echo=FALSE, message=FALSE}
wrapped_16_20 <-
  bind_rows(
    wrapped16 %>% mutate(category = "2016", playlist = 'wrapped 2016'),
    wrapped17 %>% mutate(category = "2017", playlist = 'wrapped 2017'),
    wrapped18 %>% mutate(category = "2018", playlist = 'wrapped 2018'),
    wrapped19 %>% mutate(category = "2019", playlist = 'wrapped 2019'),
    wrapped20 %>% mutate(category = "2020", playlist = 'wrapped 2020')
  )

wrapped_16_20less <-
  bind_rows(
    wrapped16 %>% mutate( playlist = 'wrapped 2016') %>% slice_head(n = 25),
    wrapped17 %>% mutate( playlist = 'wrapped 2017') %>% slice_head(n = 25),
    wrapped18 %>% mutate( playlist = 'wrapped 2018') %>% slice_head(n = 25),
    #wrapped19 %>% mutate( playlist = 'wrapped 2019') %>% slice_head(n = 10),
    wrapped20 %>% mutate( playlist = 'wrapped 2020') %>% slice_head(n = 25)
  )

wrapped_16_20class <-
  bind_rows(
    wrapped16 %>% mutate( playlist = 'wrapped 2016')  ,
    wrapped17 %>% mutate( playlist = 'wrapped 2017')  ,
    wrapped18 %>% mutate( playlist = 'wrapped 2018')  ,
    #wrapped19 %>% mutate( playlist = 'wrapped 2019')  ,
    wrapped20 %>% mutate( playlist = 'wrapped 2020') 
  )
```

``` {r chromas, include = FALSE, echo=FALSE, message=FALSE}
FLS <-
  get_tidy_audio_analysis("7p4vHnYXkxlzvfePJVpcTr") %>% 
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)


FLSCHROMA <- FLS %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c(option="inferno") +
  theme_classic() +
  ggtitle("Feels Like Summer - Childish Gambino") 

FLS2 <-
  get_tidy_audio_analysis("7p4vHnYXkxlzvfePJVpcTr") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  FLS2 %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  FLS2 %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")




circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}
#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)
major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)
chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )
key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
Build_God <-
  get_tidy_audio_analysis("7MMOPTjs6nZL0wf6C9ECKX") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )
Buildplot <- Build_God %>% 
  compmus_match_pitch_template(
    key_templates,         
    method = "euclidean",  
    norm = "manhattan"     
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none",option = "inferno")  +
  labs(x = "Time (s)", y = "") +
  theme_classic() +
  ggtitle("2019-2020 ")

Bohem <-
  get_tidy_audio_analysis("1AhDOtG9vPSOmsWgNW0BEY") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Bohemplot <- Bohem %>% 
  compmus_match_pitch_template(
    key_templates,         
    method = "euclidean",  
    norm = "manhattan"     
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none",option = "inferno")  +
  labs(x = "Time (s)", y = "") +
  theme_classic() +
  ggtitle("2018")

Weight <-
  get_tidy_audio_analysis("2UZZtkoLOg7IHxeTAdPFvd") %>%
 compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Wplot <- Weight %>% 
  compmus_match_pitch_template(
    key_templates,         
    method = "euclidean",  
    norm = "manhattan"     
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none",option = "inferno")  +
  labs(x = "Time (s)", y = "") +
  theme_classic() +
  ggtitle("2017")

Sub <-
  get_tidy_audio_analysis("10lT3pp9QERGOWiIzLx4We") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

Suburplot <- Sub %>% 
  compmus_match_pitch_template(
    key_templates,         
    method = "euclidean",  
    norm = "manhattan"     
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none",option = "inferno") +
  labs(x = "Time (s)", y = "") +
  theme_classic() +
  ggtitle("2016")

```

```{r tempograms, include = FALSE, echo=FALSE, message=FALSE}
build_temp <- get_tidy_audio_analysis("7MMOPTjs6nZL0wf6C9ECKX")
sub_temp <- get_tidy_audio_analysis("10lT3pp9QERGOWiIzLx4We")
bohem_temp <- get_tidy_audio_analysis("1AhDOtG9vPSOmsWgNW0BEY")
weight_temp <- get_tidy_audio_analysis("2UZZtkoLOg7IHxeTAdPFvd")
  
tempbuild <- build_temp %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none", option = "inferno") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  ggtitle("2019-2020") +
  theme_classic()

tempsub <- sub_temp %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none", option = "inferno") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  ggtitle("2016") +
  theme_classic()

tempweight <- weight_temp %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none", option = "inferno") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  ggtitle("2017") +
  theme_classic()

tempbohem <- bohem_temp %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none", option = "inferno") +
  labs(x = "Time (s)", y = "Tempo (BPM)") +
  ggtitle("2018") +
  theme_classic()

```


``` {r graphs, include = FALSE, echo=FALSE, message=FALSE}
mid <- mean(wrapped_16_20$valence)

valendancepopyear <- wrapped_16_20 %>%
 ggplot(                          # Set up the plot.
    aes(
      x = danceability,
      y = energy,
      size = 1,
      color = valence,
      label = track.name           # Labels will be interactively visible.
    )
  ) +
  geom_point(alpha=0.7) +                   # Scatter plot.
  geom_rug(size = 0.1) +           # Add 'fringes' to show data distribution.
  facet_wrap(~category) +           # Separate charts per country.
  scale_x_continuous(              # Fine-tune the x axis.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),        # Use grid-lines for quadrants only.
    minor_breaks = NULL            # Remove 'minor' grid-lines.
  ) +
  scale_y_continuous(              # Fine-tune the y axis in the same way.
    limits = c(0, 1),
    breaks = c(0, 0.50, 1),
    minor_breaks = NULL
  ) +
  scale_color_gradient2(midpoint=mid, low="red", mid="blue", high="green", space ="Lab") +
  #scale_colour_viridis_b(          # Use the cividis palette
  #  option = "A",                  # Qualitative set.
  #  alpha = 0.8,                   # Include some transparency
  #) +
  #scale_size_continuous(           # Fine-tune the sizes of each point.
   # guide = "none"                 # Remove the legend for size.
  # ) +
  theme_tufte() +                 # Use a simpler theme.
  labs(                            # Make the titles nice.
    x = "Danceability",
    y = "Energy"
  ) 
  #theme(strip.background = element_rect(fill="#960000"))

```


```{r hists/bars, include=FALSE, echo=FALSE, message=FALSE}

keyfreqyear <- wrapped_16_20 %>%
ggplot(aes(x = factor(key_name), fill = mode_name)) +
  geom_bar() +
  xlab("Keys") +
  ylab("Frequency")+
  ggtitle("Key frequency wrapped 2016-2020") +
  theme_tufte() +
  scale_fill_discrete(guide=FALSE) +
  facet_wrap(~category)

modefreqyear <- wrapped_16_20 %>%
  ggplot(aes(x = factor(mode))) +
  geom_bar() +
  xlab("Mode (factored)") +
  ylab("Frequency")+
  ggtitle("Mode Spotify wrapped per year") +
  scale_x_discrete(labels=c("0" = "Minor", "1" = "Major")) +
  theme_tufte() +
  facet_wrap(~category)

valdens <-  wrapped_16_20 %>%
  ggplot(aes( x = valence)) +
   geom_histogram(aes(y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density( alpha=.2, fill="#FF6666")  + # Overlay with transparent density plot
  facet_wrap(~category) +
  theme_tufte() 

yearenergy <-  wrapped_16_20 %>%
  ggplot(aes( x = energy)) +
   geom_histogram(aes(stat = "bin", y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density( alpha=.2, fill="#FF6666")  + # Overlay with transparent density plot
  facet_wrap(~category) +
  theme_tufte() 

yearloudness <-  wrapped_16_20 %>%
  ggplot(aes( x = loudness)) +
   geom_histogram(aes(stat = "bin", y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density( alpha=.2, fill="#FF6666")  + # Overlay with transparent density plot
  facet_wrap(~category) +
  theme_tufte() 


yeardanceability <-  wrapped_16_20 %>%
  ggplot(aes( x = danceability)) +
   geom_histogram(aes(stat = "bin", y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density( alpha=.2, fill="#FF6666")  + # Overlay with transparent density plot
  facet_wrap(~category) +
  theme_tufte() 

yearacousticness <-  wrapped_16_20 %>%
  ggplot(aes( x = acousticness)) +
   geom_histogram(aes(stat = "bin", y=..density..),      # Histogram with density instead of count on y-axis
                   binwidth=.5,
                   colour="black", fill="white") +
    geom_density( alpha=.2, fill="#FF6666")  + # Overlay with transparent density plot
  facet_wrap(~category) +
  theme_tufte() 

yearinstrumentalness <-  wrapped_16_20 %>%
  ggplot(aes( x = instrumentalness)) +
  geom_histogram(binwidth=.5,colour="black", fill="white") +
  facet_wrap(~category) +
  theme_tufte() 

histtempo <-  wrapped_16_20 %>%
  ggplot(aes( x = tempo)) +
   geom_histogram(aes( y=..density..),      # Histogram with density instead of count on y-axis
                   colour="black", fill="white") +
    geom_density( alpha=.2, fill="#FF6666")  + # Overlay with transparent density plot
  facet_wrap(~category) +
   labs(x = "Tempo (BPM)", y = "Density")
  theme_tufte() 


```

```{r class prepro, include=FALSE, echo=FALSE, message=FALSE}




wrapped_features <-
 wrapped_16_20class %>%  # For your portfolio, change this to the name of your corpus.
  add_audio_analysis() %>% 
  mutate(
    playlist = factor(playlist),
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(
        segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean",
      )
  ) %>%
  mutate(pitches = map(pitches, compmus_normalise, "clr")) %>%
  mutate_at(vars(pitches, timbre), map, bind_rows) %>%
  unnest(cols = c(pitches, timbre))



# prepro

wrappedcipe <-
  recipe(
    playlist ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration +
      C + `C#|Db` + D + `D#|Eb` +
      E + `F` + `F#|Gb` + G +
      `G#|Ab` + A + `A#|Bb` + B +
      c01 + c02 + c03 + c04 + c05 + c06 +
      c07 + c08 + c09 + c10 + c11 + c12,
    data = wrapped_features,          # Use the same name as the previous block.
  ) %>%
  step_center(all_predictors()) %>%
  step_scale(all_predictors())      # Converts to z-scores.
  # step_range(all_predictors())    # Sets range to [0, 1].



```

```{r class, include=FALSE, echo=FALSE, message=FALSE}
wrapped_cv <- wrapped_features %>% vfold_cv(5)

knn_model <-
  nearest_neighbor(neighbors = 1) %>%
  set_mode("classification") %>% 
  set_engine("kknn")
wrapped_knn <- 
  workflow() %>% 
  add_recipe(wrappedcipe) %>% 
  add_model(knn_model) %>% 
  fit_resamples(
    wrapped_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```

```{r trees, include=FALSE, echo=FALSE, message=FALSE} 

tree_model <-
  decision_tree() %>%
  set_mode("classification") %>% 
  set_engine("C5.0")
wrapped_tree <- 
  workflow() %>% 
  add_recipe(wrappedcipe) %>% 
  add_model(tree_model) %>% 
  fit_resamples(
    wrapped_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```

```{r forest, include=FALSE, echo=FALSE, message=FALSE} 

forest_model <-
  rand_forest() %>%
  set_mode("classification") %>% 
  set_engine("ranger", importance = "impurity")
wrapped_forest <- 
  workflow() %>% 
  add_recipe(wrappedcipe) %>% 
  add_model(forest_model) %>% 
  fit_resamples(
    wrapped_cv, 
    control = control_resamples(save_pred = TRUE)
  )
```


### Classfication (NEW)

#### K-Nearest Neighbours classifier

```{r KNN, echo=FALSE, message=FALSE}
wrapped_knn %>% get_conf_mat() %>% 
  autoplot(type = "heatmap") +
  labs(subtitle = "Confusion matrix heatmap for all features") +
  scale_fill_viridis_c( guide = "none", option = "E")
  
wrapped_knn %>% get_pr()
```

***

* KNN classification over 4 of the 5 lists from my Spotify wrapped 2016-2020 corpus, (2019 excluded due to errors) 

#### Decision Tree Classifier

```{r dtree, echo=FALSE, message=FALSE}
wrapped_tree %>% get_conf_mat() %>% 
  autoplot(type = "heatmap") +
  labs(subtitle = "Confusion matrix heatmap for all features") +
  scale_fill_viridis_c( guide = "none", option = "E")
wrapped_tree %>% get_pr()
```

***

* Decision tree classification over 4 of the 5 lists from my Spotify wrapped 2016-2020 corpus, (2019 excluded due to errors) 

#### Random Forest Classifier

```{r rforest, echo=FALSE, message=FALSE}

wrapped_forest %>% get_conf_mat() %>%
  autoplot(type = "heatmap") +
  labs(subtitle = "Confusion matrix heatmap for all features") +
  scale_fill_viridis_c(guide = "none", option = "E")
wrapped_forest %>% get_pr()
```

***

* Random forest classification over 4 of the 5 lists from my Spotify wrapped 2016-2020 corpus (2019 excluded due to errors) 



### Time (Tempo histogram with density) 

```{r echo=FALSE, message=FALSE}
ggplotly(histtempo)
```

***

* The tempo of the songs in my spotify wrapped playlists mostly seem to hang around 100-120 BPM. Starting at 110 BPM in 2016 then 100 BPM in 2017/2018, shooting up to 120 BPM in 2019 and reverting back to 100 BPM in 2020.


### And Time again (Tempograms for Outliers)

```{r echo=FALSE, message=FALSE}
tempsub +
tempweight +
tempbohem +
tempbuild  +
plot_layout(ncol = 2)
```

*** 

* Outliers:

* 2016 Jesus of Suburbia - Green Day: an outlier because the song has lots of different sections and tempo changes.

* 2017 Weightless part 1 - Marconi Union: an outlier because its sleep music and is not something you would listen to on the regular.

* 2018 Bohemian Rhapsody - Queen: an outlier because it has different sections and tempo changes.

* 2019/2020 Build God, Then We'll Talk - Panic! At The Disco: an outlier because it has different sections and tempo changes.



### Acchordingly (Chordograms for Outliers) 

```{r echo=FALSE, message=FALSE}
Suburplot + 
Wplot +
Bohemplot +
Buildplot +
plot_layout(ncol = 2)
```

***

* Outliers:

* 2016 Jesus of Suburbia - Green Day: an outlier because the song has lots of different sections and tempo changes.

* 2017 Weightless part 1 - Marconi Union: an outlier because its sleep music and is not something you would listen to on the regular.

* 2018 Bohemian Rhapsody - Queen: an outlier because it has different sections and tempo changes.

* 2019/2020 Build God, Then We'll Talk - Panic! At The Disco: an outlier because it has different sections and tempo changes.







### Keyp on moving (Key frequency) 

```{r echo=FALSE, message=FALSE}
ggplotly(keyfreqyear)
```

***

* WIP



### Feels like summer (Chromagram)

```{r echo=FALSE, message=FALSE}
plot(FLSCHROMA)
```

***

* Chromagram for the song i most frequently listened to. (under construction)

### Self-Similarity Matrices

```{r, echo = FALSE, message = FALSE}
library(tidyverse)
library(spotifyr)
library(compmus)
SelfSim_FLS <-
  get_tidy_audio_analysis("7p4vHnYXkxlzvfePJVpcTr") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "acentre", norm = "manhattan"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  )
bind_rows(
  SelfSim_FLS %>%
    compmus_self_similarity(pitches, "aitchison") %>%
    mutate(d = d / max(d), type = "Chroma"),
  SelfSim_FLS %>%
    compmus_self_similarity(timbre, "euclidean") %>%
    mutate(d = d / max(d), type = "Timbre")
) %>%
  mutate() %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  ggtitle("Feels Like Summer - Childish Gambino") +
  geom_tile() +
  coord_fixed() +
  facet_wrap(~type) +
  scale_fill_viridis_c(guide = "none",option = "inferno") +
  theme_classic() +
  labs(x = "", y = "")
```

***

* Chroma and Timbre self-similarity matrices for the song i most frequently listened to. At multiple segments in the song (at around 120, 300 and constantly during the outro) there is a section where most instruments fade out and come back in with Childish Gambino belting a high note, this could explain the intersections at those times in the chroma an timbre graphs. Whats interesting is that the timbre graph singles out the segment at 200 seconds. This is because not just some but all the other instruments stop for a moment as a opposed to earlier and later occurrences of a similar segment, resulting in the biggest difference in timbre.


### Introduction



#### Spotify Wrapped 2016-2020
Every december Spotify makes you a "wrapped" playlist of the 100 songs you most frequently listened to that year giving a clear picture of your music taste that year. I've always found that my music taste is kind of variable with a lot of different genre's so it would be interesting to see how my music taste has changed from 2016 till now. To compare my music taste from 2016 to 2020 i will analyze my Spotify wrapped 2016-2020 playlists using the following metrics: **valence, danceability, energy, tempo and modality.**

After getting a global idea i'd like to take one favorite song from each year which i will compare in more depth, using the metrics mentioned above and chroma/timbregrams to look at similarities/differences. (WIP)

#### Corpus:

My Corpus is divided into 5 groups of spotify wrapped playlists representing 2016 to 2020:

[Wrapped 2016](https://open.spotify.com/playlist/37i9dQZF1Cz24RS3exilwM?si=ZOze5nWySsWErYrc3xVM4Q)

[Wrapped 2017](https://open.spotify.com/playlist/37i9dQZF1E9Jzat5fcogxI?si=1ehaYOK2QXaN7Zj5addPPw)

[Wrapped 2018](https://open.spotify.com/playlist/37i9dQZF1EjvCrCRRFYOR7?si=Yr8yJlFfTmCiSsGq3JJtWQ)

[Wrapped 2019](https://open.spotify.com/playlist/37i9dQZF1Etlshd0CHSHbz?si=WTbkaVjySZizef_MzektQA)

[Wrapped 2020](https://open.spotify.com/playlist/37i9dQZF1EMdGOBLndfzlm?si=yB3xeK53Trqhc_xIE69a3A)




### Because I'm Happy...? (Valence density plot)

```{r echo=FALSE, message=FALSE}
ggplotly(valdens)

```

***

* You can clearly see that most of my favorite songs in 2016, 2017 and 2018 were "happier" than my most favorite songs in 2019 and 2020. Although 2019 has some outliers with music used for sleeping which all have a really low valence score.


### Multivariate Musicology (Valence, energy, danceability)

```{r echo=FALSE, message=FALSE}
ggplotly(valendancepopyear)

```


***

* WIP



